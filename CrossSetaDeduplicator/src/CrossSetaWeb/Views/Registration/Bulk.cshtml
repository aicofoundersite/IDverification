@{
    ViewData["Title"] = "Bulk Learner Registration";
}

<style>
    .section-header {
        background-color: SeaGreen;
        color: white;
        padding: 10px;
        font-weight: bold;
        margin-top: 20px;
        margin-bottom: 20px;
    }
    .form-label {
        font-weight: 500;
        font-size: 0.9rem;
    }
</style>

<div class="container">
    <h2 style="color: SeaGreen; font-weight: bold;">Bulk Learner Registration</h2>
    <p class="text-muted">Use this page to upload CSV files for bulk learner registration. This is intended for SETAs, Companies, and Training Providers.</p>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">@TempData["SuccessMessage"]</div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-warning">
            @TempData["ErrorMessage"]
            @if (TempData["ReportFileName"] != null)
            {
                <br/>
                <a href="@Url.Action("DownloadReport", "Registration", new { fileName = TempData["ReportFileName"] })" class="btn btn-warning btn-sm mt-2">
                    <i class="bi bi-download"></i> Download Error Report
                </a>
            }
        </div>
    }

    @if (!ViewData.ModelState.IsValid)
    {
        <div class="alert alert-danger">
            <strong>Import Issues:</strong>
            @Html.ValidationSummary(false)
        </div>
    }

    <form asp-action="Bulk" method="post" enctype="multipart/form-data">
        
        <div class="section-header">Upload CSV File</div>
        
        <div class="row">
            <div class="col-md-12 mb-3">
                <label class="form-label">Select CSV File*</label>
                <input type="file" name="csvFile" class="form-control" accept=".csv" required />
                <small class="text-muted">File must be a valid CSV containing learner details.</small>
            </div>
        </div>

        <div class="section-header">CSV Format Guidelines</div>
        <div class="alert alert-info">
            <p>Please ensure your CSV follows the exact format of the WRSETA Template (in order):</p>
            <ul>
                <li><strong>First Name / s</strong> (Required)</li>
                <li><strong>Surname</strong> (Required)</li>
                <li><strong>Date of Birth</strong> (Required, dd/MM/yy)</li>
                <li><strong>Identity Number</strong> (Required)</li>
                <li><strong>Target #</strong> (Optional)</li>
                <li><strong>Intervention Name</strong> (Optional)</li>
                <li><strong>Period</strong> (Optional)</li>
            </ul>
            <p>Example: <code>Sange,Gana,10/05/01,0105105408089,11,Bursary,2024/2025</code></p>
            <p><em>Note: ID numbers will be validated using the Luhn algorithm. Duplicates will be skipped or reported.</em></p>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary" style="background-color: SeaGreen; border-color: SeaGreen;">Upload and Process</button>
            <a href="@Url.Action("Learner", "Registration")" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; flex-direction: column; justify-content: center; align-items: center;">
    <div class="spinner-border text-success" role="status" style="width: 4rem; height: 4rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
    <h3 class="mt-3 text-success" style="color: SeaGreen !important;">Processing Bulk Upload...</h3>
    <p class="text-muted">Please wait while we validate and process your records.</p>
    <p class="text-muted small">Do not close or refresh this page.</p>
</div>

<script>
    document.querySelector('form').addEventListener('submit', function(e) {
        // Simple client-side validation check before showing spinner
        var fileInput = document.querySelector('input[type="file"]');
        if (fileInput.files.length > 0) {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
    });
</script>